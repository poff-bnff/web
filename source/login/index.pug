extends /_templates/layout.pug
include /_templates/mixins.pug

block content

    br
    br
    br
    br
    br
    h4#number Log in without hosted UI:
    label(style={color: 'red'} for='loginUsername') Username:
    input#loginUsername(type='text')
    br
    label(style={color: 'red'} for='loginPassword') Password:
    input#loginPassword(type='password')
    br
    a(href='https://tests.auth.us-east-2.amazoncognito.com/oauth2/authorize?response_type=code&client_id=67tu3fmm9v7ho8mnsltcd6h5p3&redirect_uri=https://dev.inscaping.eu/login/&identity_provider=Facebook') Facebook
    br
    a(href='https://tests.auth.us-east-2.amazoncognito.com/oauth2/authorize?response_type=code&client_id=67tu3fmm9v7ho8mnsltcd6h5p3&redirect_uri=https://dev.inscaping.eu/login/&identity_provider=Google') Google
    br
    button(onclick='login()') Login
    br
    br
    br
    a(href='https://tests.auth.us-east-2.amazoncognito.com/logout?client_id=67tu3fmm9v7ho8mnsltcd6h5p3&logout_uri=https://dev.inscaping.eu/login/' onclick='logOut()')#logOutLink Log out
    br
    br
    h1#hello
    br
    br
    a(href='https://tests.auth.us-east-2.amazoncognito.com/login?client_id=67tu3fmm9v7ho8mnsltcd6h5p3&response_type=code&scope=aws.cognito.signin.user.admin+email+openid+phone+profile&redirect_uri=https://dev.inscaping.eu/login/') (Log in via hosted UI)
    br
    button(onclick='toLocalhost()') Switch back to localhost
    br
    button(onclick='loadCognitoUser()') Say Hello to Cognito user via token+userInfo request


    style.
        h1 {color: #464646}
        h4 {color: #464646}


    script.
        var url = window.location;
        const ACCESS_TOKEN = "ACCESS_TOKEN";
        const REFRESH_TOKEN = "REFRESH_TOKEN";
        const ID_TOKEN = "ID_TOKEN";

        if (localStorage.getItem('ID_TOKEN')){
            hello.innerHTML = 'Hello, ' + name;
        } else {
            hello.innerHTML = 'Not logged in'
        }

        var code = new URLSearchParams(url.search).get('code')
        console.log(code);
        if (code) {
            //- getReplyFromAWS(code);
            loginWithCode(code)
            console.log('Code sent: ' + code);
        } else {
            console.log('Not sent ')
        }








        function toLocalhost(){
            let url = 'http://localhost:4000/login/' + window.location.search;
            window.location.replace(url);
        }

        async function loginWithCode(code) {

            var myHeaders = new Headers();

            myHeaders.append("Content-Type", "application/x-www-form-urlencoded");
            myHeaders.append("Authorization", "Basic Njd0dTNmbW05djdobzhtbnNsdGNkNmg1cDM6MTZ1cDVlYW5mMzVqczVvcXNnM2ticmtuaGI5ZmkxbzJxMjcxNmkzNG9vcnVsa29pbnUybg==");
            myHeaders.append("Cookie", "XSRF-TOKEN=e7ac0bb5-d5b1-4e39-8692-2fb0600fbb64");

            var urlencoded = new URLSearchParams();
            urlencoded.append("grant_type", "authorization_code");
            urlencoded.append("redirect_uri", "https://dev.inscaping.eu/login/");
            urlencoded.append("code", code);

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: urlencoded,
                redirect: 'follow'
            };

            await fetch("https://tests.auth.us-east-2.amazoncognito.com/oauth2/token", requestOptions)
                .then(response => response.text())
                .then(result => {
                    console.log(result);
                    const JSONresult = JSON.parse(result);
                    console.log(JSONresult.access_token);
                    if (JSONresult.access_token && JSONresult.refresh_token) {
                        storeAuthentication(JSONresult);
                    }
                })
                .catch(error => console.log('error', error));
        }


        async function storeAuthentication(JSONresult) {
            localStorage.setItem(ACCESS_TOKEN, JSONresult.access_token);
            localStorage.setItem(REFRESH_TOKEN, JSONresult.refresh_token);
            localStorage.setItem(ID_TOKEN, JSONresult.id_token);
            await loadInfoFromIdtkn();
            location.reload();
        }

        function getAccessToken() {
            token.innerHTML = localStorage.getItem(`ACCESS_TOKEN`);
            return localStorage.getItem(`ACCESS_TOKEN`);
        }

        function logOut() {
            localStorage.removeItem(ACCESS_TOKEN);
            localStorage.removeItem(REFRESH_TOKEN);
            localStorage.removeItem(ID_TOKEN);
            console.log('LOGITUD VÃ„LJA');
            location.reload();
        }







        async function loadCognitoUser(){
            console.log(localStorage.getItem(ACCESS_TOKEN));
            var myHeaders = new Headers();

            myHeaders.append('Authorization', `Bearer ${localStorage.getItem(ACCESS_TOKEN)}`);

            var requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            console.log(requestOptions.headers);

            await fetch("https://tests.auth.us-east-2.amazoncognito.com/oauth2/userInfo", requestOptions)
                .then(response => response.text())
                .then(result => {
                    console.log(result);
                    const JSONresult = JSON.parse(result);
                    console.log(JSONresult.name);
                    hello.innerHTML = 'Hello, ' + JSONresult.name + '(token+userInfo request)';
                })
                .catch(error => console.log('error', error));
        }




        async function login(){

            let loginUsername = document.getElementById('loginUsername').value;
            let loginPassword = document.getElementById('loginPassword').value;


        // Amazon Cognito creates a session which includes the id, access, and refresh tokens of an authenticated user.

            var authenticationData = {
                    Username : loginUsername,
                    Password : loginPassword
            };

            var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            var poolData = {
                    UserPoolId : 'us-east-2_1bCsYSArV',
                    ClientId : '6t3b33mud4uacl644m2k0i1vuv'
            };

            var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
            var userData = {
                    Username : loginUsername,
                    Pool : userPool
            };

            var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: async function (result) {
                    //- var accessToken = result.getAccessToken().getJwtToken();
                    localStorage.setItem('ACCESS_TOKEN', result.accessToken.jwtToken);
                    localStorage.setItem('REFRESH_TOKEN', result.refreshToken.token);
                    localStorage.setItem('ID_TOKEN', result.idToken.jwtToken);
                    await loadInfoFromIdtkn();
                    location.reload();

                    /* Use the idToken for Logins Map when Federating User Pools with identity pools or when passing through an Authorization Header to an API Gateway Authorizer */
                    var idToken = result.idToken.jwtToken;

                },

                onFailure: function(err) {
                    alert(JSON.stringify(err));
                },
            });
        }


        async function loadInfoFromIdtkn(){
            let response = await fetch(`https://kewlo9ntw1.execute-api.eu-north-1.amazonaws.com/dev/tkns`, {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem('ID_TOKEN')}

                });
                let name1 = await response.json();
                name = name1.message;
                //- hello.innerHTML = 'Hello, ' + name.message;
                //- return await response.json();
                //- return processJsonResponse(response);

        }






    //- async function getReplyFromAWS(code) {
            //-     let response = await fetch(`https://9t1wskosmj.execute-api.eu-central-1.amazonaws.com/default/POFF-Validate`, {
            //-         method: 'POST',
            //-         //- headers: {Authorization: 'Bearer ' + accessToken}
            //-         body: code
            //-     });
            //-     return await response.json();
            //-     //- return processJsonResponse(response);
            //- }














